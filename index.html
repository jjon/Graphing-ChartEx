<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
<title>Quick and Dirty: visualize graph as bubbles and arrows, and as rdf/n3</title>
<!-- 
deeds-00880644 most smushing.
deeds-00110292.ann Robin's graph, intercoding exercise, compare w/others
-->
<!-- 
<style type="text/css">@import "./sorter-green/style.css";</style> -->
<link rel="stylesheet" type="text/css" href="http://localhost/Sites/Ann2DotRdf/sorter-green/style.css"></link>

<style>
body {font-size: 9pt}

.legend {
    font-weight: bold; 
    font-size: 130%; 
    margin: 0 0 0 60; 
    border-left: 3px solid #880000;
    padding-left: 6px;
}

#ftcontainer {
    width: 200px;
    float: left;
    clear: left;
}
#doc_text_display {
    display: none;
    background-color: #fec;
    position: absolute;
    text-align: center;
    width: 400px;
    border: double #999;
    max-height: 400px;
}

#doc_text {
    padding: 16px;
    text-align: justify;
}

.node {
    cursor: pointer;
}

.doc-highlight {
    background-color: #f00;
}


#dotimg {
    float:left;
}

#graph { width: 800px }

#rdfout { 
    clear: left;
    width: 800px;
    margin-left: auto;
    margin-right: auto;
    font-family: Monaco, Verdana, Arial, Helvetica, sans-serif;
}

.jqueryFileTree {
    padding: 0 0 0 24;
}

#searchAndResult {width: 45%; margin-left: 60px; float: left; padding: 6px; border: 1px solid green}
/*
#searchAndResult p {margin: 0px}
*/
#toggleSearch {
    font-size: 12pt;
    margin-left: 60px;
    /*border: 1px solid;*/
    /*width: 120px;*/
    float: left;
}
#toggleSearch:hover {color: #800; cursor: pointer}
#dome {float: left; padding: 6px; background-color: #fec; border: 3px double #800;}
#dome td {font-size: 9pt}
.tkey {border-top: 1px solid #800; border-right: 4px solid #800}
#result-div {float: left; max-height: 300px; overflow: scroll}

#simplemodal-container a.modalCloseImg {
	background:url(close.png) no-repeat; /* adjust url as required */
	width:25px;
	height:29px;
	display:inline;
	z-index:3200;
	position:absolute;
	top:-15px;
	right:-18px;
	cursor:pointer;
}

</style>

<script src="./jquery-1.7.1.min.js"></script>
<script src="./jqueryFileTree/jqueryFileTree.js"></script>
<script language="javascript" type="text/javascript" src="jquery.tablesorter.min.js"></script>
<script type="text/javascript">

var doc_text = ""; // the only global should be a json object with all the data: svg, text, and rdf.
var dirs_with_ann_files = undefined


function hideme() {
    $('#doc_text_display').toggle('fast');
    $('#doc_text').empty();
}

/************************/

function replaceOffset(str, offsetArray, tag) {
    tag = tag || '<span class="doc-highlight">';
    var arr = str.split('');
    for (i = 0; i < offsetArray.length; i++) {
        var start = offsetArray[i][0];
        var end = offsetArray[i][1];
        arr[start] = tag + arr[start];
        arr[end] = "</span>" + arr[end];
    }
    return arr.join('');
}

/************************/

function deployData(pydata) {
    var dataIn = pydata.split('<filedelimiter>'); // use json instead of this
    var svg = $(dataIn[0]).find('svg');
    var rdf = dataIn[1]; //.replace(/\n/gi,'<br />');
    // getting rid of the pesky newlines. Should'a used json for transport!
    doc_text = dataIn[2].split('\n');
    var str = '';
    for (str = 0; str < doc_text.length; str++) {
        if (!doc_text[str].length) {
            doc_text.splice(str, 1);
        }
    }
    doc_text = doc_text.join(' ');
    
    $('#doc_text').empty();
    $('#doc_text_display').hide();
    $("#dotimg").empty();
    $("#dotimg").append(dataIn[0]);
    $("svg")[0].width.baseVal.value = 800;
    $("svg")[0].height.baseVal.value = 800;

    //$("#rdfout").html("<div>" + rdf + "</div>"); //<> namespace declarations interpreted as html and brackets evaporate.
    document.getElementById("rdfout").innerText = "\nThe same graph rendered as RDF/n3:\n\n" + rdf; //innerText is a MS invention, not standards compliant.
    // click function for graph nodes: show doc_text w/offsets highlighted.
    $('.node').click(function(e) {
        var $that = $(this);
        var offsets = [];

        // gather the offsets from the Literals containing them
        $that.find('text').contents().each(function(i) {
            var regexp = /\((\d+),\s(\d+)\)/g;
            var match = regexp.exec(this.data);
            if (match !== null) {
                offsets.push([match[1], match[2]]);
            }
        });

        // call replaceOffset to highlight occurences of Literal text in the document text.
        var fillColor = $(this).find('ellipse').css('fill');
        $("#doc_text").html(replaceOffset(doc_text, offsets, '<span style="background-color:' + fillColor + '">'));
        var X = e.pageX - 200;
        var Y = e.pageY + 16;
        $('#doc_text_display').hide();
        $('#doc_text_display').css('overflow-y', 'auto');
        $('#doc_text_display').css({
            left: X,
            top: Y
        }).toggle('slow');
    });
}



/***********************/

function graphme(filepath){
    $.ajax({
        url: "ann2rdf_dot.py",
        dataType: 'text',
        data: {'fp': filepath},
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.response, textStatus, errorThrown);
        },
        success: function(pydata) {
            if (pydata.search("<filedelimiter>") >= 0) {
                $(".expanded a").first().trigger('click');
                deployData(pydata);
                $('html, body').animate({
                    scrollTop: $("#dotimg").offset().top
                }, 2000);    
            }
            
            else {alertError(pydata);}
        }
    });
}

/***********************/

function alertError(pydata) {
    $('#doc_text_display').hide();
    $("#dotimg").empty();
    $("#rdfout").empty();
    $("#doc_text").empty();
    doc_text = "";
    alert("that file has no annotations");
}

/***********************/


$(document).ready(function() {
    //populate the 'directoriesToSearch' dropdown list
    $.ajax({
        url: "jqueryFileTree.py",
        dataType: 'json',
        data: {
            'dirs': '/Users/jjc/Sites/Ann2DotRdf/chartex'
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.response, textStatus, errorThrown);
        },
        success: function(pydata) {
            dirs_with_ann_files = pydata;
            for (i=0; i<dirs_with_ann_files.length; i++){
                $("#directoriesToSearch").append('<option value="'+ dirs_with_ann_files[i] +'">' + dirs_with_ann_files[i].split('/').slice(6).join('/') + '</option>');
            }
        }
    });

    $("#toggleSearch").click(function(){
        $("#result-div").remove();
        $("#searchAndResult").slideToggle();
    });


    $('#ftcontainer').fileTree({
        root: '/Users/jjc/Sites/Ann2DotRdf/chartex',
        script: 'jqueryFileTree.py',
        expandSpeed: 300,
        collapseSpeed: 300,
        multiFolder: false
    }, function(file) { //NB the 'file' argument root + filename
        $.ajax({
            url: "ann2rdf_dot.py",
            dataType: 'text',
            data: {
                'fp': file
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(jqXHR.response, textStatus, errorThrown);
            },
            success: function(pydata) {
                if (pydata.search("<filedelimiter>") >= 0) {deployData(pydata);}
                else {alertError(pydata);}
            }
        });
    });

    

    $('#submitButton').click(function(){
        // similar string search function
        var dirToSearch = $("select#directoriesToSearch").val();
        var EntityToSearch = $("select#EntityToSearch").val();
        var editDistance = $("select#editDistance").val();
        var targetString = $("input#searchstring").val();
                
        $.ajax({
            type: "get",
            url: "ann2rdf_dot.py",
            data: {'searchstring': targetString, 'entity': EntityToSearch, 'editDistance': editDistance, 'dirToSearch': dirToSearch},
            dataType: 'json',
            success: function(pydata){
                if (pydata.length > 0) {
                    console.log(pydata);
                    $("#result-div").remove();
                    $("#searchAndResult").append('<div id="result-div"><table id="result-table" class="tablesorter"><thead><tr><th>found string</th><th>edit distance</th><th>file: click on the file to graph it below</th></tr></thead><tbody id="result"></tbody></table></div>');
                    for (match in pydata){
                        $("#result").append('<tr><td>' + pydata[match].text + '</td><td class="distance-cell">' + pydata[match].distance + '</td><td>' + '<a onclick="graphme(\'' + pydata[match].file + '\')" href="#">' + pydata[match].file.split('/').slice(6).join('/') + '</a></td></tr>');
                    }
                    $("#result-table").tablesorter();
                } else {
                    $("#result-div").remove();
                    alert("No Result");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(jqXHR.response, textStatus, errorThrown);
            }
        });
        return false
    });


});

</script>

</head>

<body>
<div id="legendDiv" style="float: left">
    <div style="float: left; font-size: 200%; font-weight: bold; color: #880000; padding-top: 16px; width: 32px">NB:</div>
    <p class='legend'>This web application is fragile and provisional.
    <p class='legend'>Choose a corpus from the list at the left, then click on an annotation file.
    <p class='legend'>Our <i>brat</i> annotations will be rendered as a directed graph (bubbles and arrows),
    <p class='legend'>and below that, as an RDF/n3 graph.</p>
</div>

    <h1 id="toggleSearch">Damerau-Levenshtein Similarity Search <span style="font-size: 60%">(show/hide)</span></h1>


<div id="searchAndResult">
    <p>Search the selected corpus for marked up entities of the type selected that are similar to the target string. Selecting a Levenshtein distance of '0' will return exact matches. This search is case-insensitive.</p>
    <form id="dome" method="post" action=""/>
        <table>
        <tr>
            <td class="tkey">Directory to search:</td>
            <td><select id="directoriesToSearch">
              <option>All</option>
            </select></td>
        </tr>
        
        
        <tr>
            <td class="tkey">Entities to search:</td>
            <td>
            <select id="EntityToSearch">
              <option></option>
              <option>Person</option>
              <option>Place</option>
              <option>Site</option>
            </select>
            </td>
        </tr>
        <tr>
            <td class="tkey">Maximum Levenshtein distance:</td>
            <td>
            <select id="editDistance">
              <option>0</option>
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
              <option>11</option>
              <option>12</option>
              <option>13</option>
              <option>14</option>
              <option>15</option>
            </select>
            </td>
        </tr>
        <tr>
            <td class="tkey">Target string:</td>
            <td><input id="searchstring" type="text" /></td>
        </tr>
        </table>
        <input type="submit" value="Search" id="submitButton" />
        <input type=reset value=Clear />
    
    </form>
</div>

<div id="doc_text_display"><img style="float: left; cursor: pointer;" src="close.png" onclick="hideme()"/><div id="doc_text"></div></div>
<div id="ftcontainer"></div>
<div id="dotimg"></div>
<div id="rdfout"></div>

</body>

</html>